generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

model User {
  createdAt         DateTime         @default(now())
  email             String           @unique
  name              String
  role              UserRole         @default(USER)
  updatedAt         DateTime         @updatedAt
  profilePictureUrl String?
  phone             String?
  creatorId         Int?
  id                Int              @id @default(autoincrement())
  uid               String           @unique @default(uuid())
  Review            Review[]
  Task              Task[]           @relation("TaskAssignee")
  SurveyResponse    SurveyResponse[] @relation("SurveyResponseUser")
  Survey            Survey[]         @relation("SurveyCreator")

  // AI Relations
  aiDesigns         AiDesign[]            @relation("AiDesigns")
  aiPreferences     UserAiPreferences?   @relation("UserAiPreferences")
  aiAnalytics       AiDesignAnalytics[]  @relation("AiDesignAnalytics")
}

model Country {
  name      String
  iso2      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  id        Int      @id @default(autoincrement())
}

model Organization {
  name                      String                     @unique
  website                   String?
  createdAt                 DateTime                   @default(now())
  updatedAt                 DateTime                   @updatedAt
  iconUrl                   String?
  address                   String?
  city                      String?
  country                   String?
  email                     String?
  foundedYear               Int?
  latitude                  Float?
  longitude                 Float?
  phone                     String?
  serviceAreas              String[]
  state                     String?
  capabilities              String?
  commercial                Boolean?
  fb_handle                 String?
  residential               Boolean?
  web_validity              Boolean?
  distributor               Boolean?
  id                        Int                        @id @default(autoincrement())
  fax                       String?
  industryId                Int                        @default(72)
  postalCode                String?
  certifications            Certification[]
  industry                  Industry                   @relation(fields: [industryId], references: [id])
  projects                  OrganizationProject[]
  descriptions              Description[]
  digitalProcesses          DigitalProcess[]
  partnerships              Partnership[]
  personnelSkills           PersonnelSkill[]
  productInnovations        ProductInnovation[]
  reviews                   Review[]
  services                  Service[]
  strategyAssessments       StrategyAssessment[]
  technologyImplementations TechnologyImplementation[]
  surveyResponses           SurveyResponse[]
}

model Industry {
  name        String
  description String
  id          Int       @id @default(autoincrement())
  organizations   Organization[]
}

model Survey {
  title           String
  description     String
  surveyJson      String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  expiresAt       DateTime?
  status          SurveyStatus     @default(DRAFT)
  targetResponses Int              @default(0)
  id              Int              @id @default(autoincrement())
  userId          Int
  industryId      Int              @default(72)
  responses       SurveyResponse[]
  user            User             @relation("SurveyCreator", fields: [userId], references: [id])

  @@index([userId, status])
  @@map("surveys")
}

model SurveyResponse {
  createdAt         DateTime  @default(now())
  responseJson      Json
  updatedAt         DateTime  @updatedAt
  id                Int       @id @default(autoincrement())
  surveyId          Int
  userId            Int
  processedMetrics  Json
  organizationId         Int       @default(1)
  lastMetricsUpdate DateTime?
  metricsVersion    String?
  organization           Organization   @relation(fields: [organizationId], references: [id])
  survey            Survey    @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  user              User      @relation("SurveyResponseUser", fields: [userId], references: [id])

  @@index([surveyId, userId])
  @@index([organizationId])
  @@map("responses")
}

model TechnologyType {
  id              Int                        @id @default(autoincrement())
  name            String                     @unique
  category        String
  description     String
  createdAt       DateTime                   @default(now())
  implementations TechnologyImplementation[]
}

model TechnologyImplementation {
  id                 Int            @id @default(autoincrement())
  organizationId          Int
  technologyTypeId   Int
  implementationDate DateTime
  maturityLevel      Int
  status             String
  investmentAmount   Decimal
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  organization            Organization        @relation(fields: [organizationId], references: [id])
  technologyType     TechnologyType @relation(fields: [technologyTypeId], references: [id])
}

model ProcessType {
  id          Int              @id @default(autoincrement())
  name        String
  category    String
  description String
  createdAt   DateTime         @default(now())
  processes   DigitalProcess[]
}

model DigitalProcess {
  id                 Int         @id @default(autoincrement())
  organizationId          Int
  processTypeId      Int
  digitizationLevel  Int
  automationLevel    Int
  implementationDate DateTime
  lastAssessmentDate DateTime
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  organization            Organization     @relation(fields: [organizationId], references: [id])
  processType        ProcessType @relation(fields: [processTypeId], references: [id])
}

model Skill {
  id              Int              @id @default(autoincrement())
  name            String
  category        String
  i40Relevance    Boolean
  description     String
  createdAt       DateTime         @default(now())
  personnelSkills PersonnelSkill[]
}

model PersonnelSkill {
  id                Int      @id @default(autoincrement())
  organizationId         Int
  skillId           Int
  numberOfPersonnel Int
  proficiencyLevel  Int
  assessmentDate    DateTime
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  organization           Organization  @relation(fields: [organizationId], references: [id])
  skill             Skill    @relation(fields: [skillId], references: [id])
}

model StrategyAssessment {
  id                     Int      @id @default(autoincrement())
  organizationId              Int
  assessmentDate         DateTime
  hasI40Strategy         Boolean
  strategyMaturity       Int
  implementationProgress Int
  nextReviewDate         DateTime
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  organization                Organization  @relation(fields: [organizationId], references: [id])
}

model ProductInnovation {
  id                 Int      @id @default(autoincrement())
  organizationId          Int
  smartFeaturesCount Int
  customizationLevel Int
  innovationDate     DateTime
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  organization            Organization  @relation(fields: [organizationId], references: [id])
}

model TechnologyImplementationFact {
  id                         Int      @id @default(autoincrement())
  date                       DateTime
  organizationId                  Int
  sectorId                   Int
  technologyCount            Int
  avgMaturityLevel           Decimal
  totalInvestment            Decimal
  implementationStatusCounts Json
  createdAt                  DateTime @default(now())
}

model ProcessDigitizationFact {
  id                   Int      @id @default(autoincrement())
  date                 DateTime
  organizationId            Int
  sectorId             Int
  processId            Int
  avgDigitizationLevel Decimal
  avgAutomationLevel   Decimal
  processCount         Int
  createdAt            DateTime @default(now())
}

model PersonnelSkillsFact {
  id                    Int      @id @default(autoincrement())
  date                  DateTime
  organizationId             Int
  sectorId              Int
  skillCategory         String
  totalSkilledPersonnel Int
  avgProficiencyLevel   Decimal
  createdAt             DateTime @default(now())
}

model StrategyImplementationFact {
  id                        Int      @id @default(autoincrement())
  date                      DateTime
  organizationId                 Int
  sectorId                  Int
  organizationsWithStrategy     Int
  avgStrategyMaturity       Decimal
  avgImplementationProgress Decimal
  createdAt                 DateTime @default(now())
}

model OrganizationProject {
  name        String
  description String?
  latitude    Float?
  longitude   Float?
  capacityKw  Float?
  completedAt DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  id          Int            @id @default(autoincrement())
  organizationId   Int
  address     String?
  organization     Organization        @relation(fields: [organizationId], references: [id])
  photos      ProjectPhoto[]
}

model ProjectPhoto {
  url       String
  caption   String?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  id        Int            @id @default(autoincrement())
  projectId Int
  project   OrganizationProject @relation(fields: [projectId], references: [id])
}

model Certification {
  name       String
  issuedBy   String?
  issuedYear Int?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  id         Int      @id @default(autoincrement())
  organizationId  Int
  organization    Organization  @relation(fields: [organizationId], references: [id])
}

model Partnership {
  name      String
  type      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  id        Int      @id @default(autoincrement())
  organizationId Int
  organization   Organization  @relation(fields: [organizationId], references: [id])
}

model Service {
  type      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  id        Int      @id @default(autoincrement())
  organizationId Int
  organization   Organization  @relation(fields: [organizationId], references: [id])
}

model Description {
  language  String
  text      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  id        Int      @id @default(autoincrement())
  organizationId Int
  organization   Organization  @relation(fields: [organizationId], references: [id])
}

model Review {
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  id        Int      @id @default(autoincrement())
  userId    Int
  organizationId Int
  organization   Organization  @relation(fields: [organizationId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

model Project {
  name        String
  description String?
  startDate   DateTime
  endDate     DateTime
  createdAt   DateTime      @default(now())
  status      ProjectStatus @default(NOT_STARTED)
  updatedAt   DateTime      @updatedAt
  id          Int           @id @default(autoincrement())
  memberIds   Int[]
  tasks       Task[]
}

model Task {
  title        String
  description  String?
  dueDate      DateTime
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  status       TaskStatus   @default(NOT_STARTED)
  priority     TaskPriority @default(MEDIUM)
  id           Int          @id @default(autoincrement())
  projectId    Int
  assignedToId Int
  assignedTo   User         @relation("TaskAssignee", fields: [assignedToId], references: [id])
  project      Project      @relation(fields: [projectId], references: [id])
}



model PVPanel {
  description         String?
  tempCoeffPmax       Float?
  tempCoeffIsc        Float?
  tempCoeffVoc        Float?
  tempCoeffIpmax      Float?
  tempCoeffVpmax      Float?
  moduleType          String?
  shortSide           Float?
  longSide            Float?
  weight              Float?
  performanceWarranty String?
  productWarranty     String?
  efficiency          Float?
  openCircuitVoltage  Float?
  shortCircuitCurrent Float?
  maxPower            Float?
  id                  Int                @id @default(autoincrement())
  certification       String?
  currentAtPmax       Float?
  voltageAtPmax       Float?
  maker               String
  maxSeriesFuseRating Float?
  model               String             @unique
  projectEquipment    ProjectEquipment[] @relation("ProjectPVPanel")

  @@index([maker, model])
}

model Inverter {
  description             String?
  phaseType               String?
  outputVoltage           Float?
  id                      Int                @id @default(autoincrement())
  acGridConnectionType    String?
  certifications          String?
  communicationInterfaces String?
  coolingMethod           String?
  dimensions              String?
  displayType             String?
  europeanEfficiency      Float?
  ipRating                String?
  maxApparentPower        Float?
  maxDcVoltage            Float?
  maxEfficiency           Float?
  maxInputCurrentPerMppt  Float?
  maxOutputCurrent        Float?
  maxOutputPower          Float?
  maxRecommendedPvPower   Float?
  maxShortCircuitCurrent  Float?
  mpptEfficiency          Float?
  mpptVoltageRangeMax     Float?
  mpptVoltageRangeMin     Float?
  noiseLevel              Float?
  nominalDcVoltage        Float?
  nominalFrequency        Float?
  nominalOutputPower      Float?
  numberOfMpptTrackers    Int?
  operatingTempRange      String?
  powerFactor             Float?
  protectionFeatures      String?
  startVoltage            Float?
  stringsPerMppt          Int?
  totalHarmonicDistortion Float?
  warrantyYears           Int?
  weight                  Float?
  maker                   String?
  model                   String             @unique
  projectEquipment        ProjectEquipment[] @relation("ProjectInverter")

  @@index([maker, model])
}

model BatteryBank {
  id                     Int                @id @default(autoincrement())
  maker                  String
  description            String?
  batteryType            String
  nominalVoltage         Float
  ratedCapacity          Float
  hourBasisForRating     Int
  internalResistance     Float
  ratedTemperature       Float
  temperatureCoefficient Float
  maxDischargeCycles     Int
  maxDepthOfDischarge    Float
  daysOfAutonomy         Int
  depthOfDischarge       Float
  unitsInSeries          Int
  stringsInParallel      Int
  totalBankBatteries     Int
  model                  String
  projectEquipment       ProjectEquipment[] @relation("ProjectBatteryBank")

  @@unique([maker, model])
  @@index([maker, model])
}

model ChargeController {
  id                          Int                @id @default(autoincrement())
  maker                       String
  description                 String?
  controllerType              String
  maxPVVoltage                Float
  maxPVCurrent                Float
  batteryVoltage              Float
  maxChargeVoltage            Float
  maxChargeCurrent            Float
  maxDischargeCurrent         Float
  tempCompensationCoefficient Float
  temperatureRating           Float
  selfConsumption             Float
  efficiency                  Float
  model                       String
  projectEquipment            ProjectEquipment[] @relation("ProjectChargeController")

  @@unique([maker, model])
  @@index([maker, model])
}

model Load {
  id            Int       @id @default(autoincrement())
  loadType      String
  quantity      Int
  usageFactor   Float
  hoursPerDay   Float
  startHour     Int
  wattage       Float
  operationMode String
  projectId     Int
  project       PVProject @relation(fields: [projectId], references: [id])

  @@index([projectId])
}

model MountingHardware {
  id               Int                @id @default(autoincrement())
  maker            String
  model            String             @unique
  description      String?
  type             String
  material         String
  maxLoad          Float
  maxWindSpeed     Float
  maxSnowLoad      Float
  warranty         String
  price            Float?
  projectEquipment ProjectEquipment[] @relation("ProjectMountingHardware")

  @@index([maker, model])
}

// Central model for all protection devices (DC and AC)
model ProtectionDevice {
  id                     Int    @id @default(autoincrement())
  maker                  String
  deviceType             DeviceType
  side                   SystemSide
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  
  // Common device properties
  model                  String?
  reference              String?
  
  // Rating properties (applicable to most devices)
  ratedVoltage           Float?
  ratedCurrent           Float?
  
  // Fuse specific properties
  minRequiredVoltage     Float?   // For requirements tracking
  minRequiredCurrent     Float?
  maxRequiredCurrent     Float?
  
  // Switch specific properties
  breakingCapacity       Float?
  
  // Circuit breaker specific properties
  differentialSensitivity Float?
  
  // Surge protector specific properties
  type                   String?   // "Type 1" or "Type 2"
  continuousOperatingVoltage Float?
  protectionLevel        Float?
  nominalDischargeCurrentKA Float?
  maxDischargeCurrentKA   Float?
  minRequiredDischargeKA  Float?
  
  // Compliance
  isCompliant            Boolean  @default(false)
  complianceIssue        String?
  recommendation         String?
  
  projectEquipment    ProjectEquipment[] @relation("ProjectProtectionDevice")

}

// Cables for both DC and AC
model Wire {
  id               Int                @id @default(autoincrement())
  maker            String
  Iz               Float             // currentCapacity
  model            String             @unique
  section          Float
  side               SystemSide
  maxVoltageDropPercent Float?
  lengthInMeters     Float?
  isCompliant        Boolean    @default(true)
  complianceIssue    String?
  projectEquipment ProjectEquipment[] @relation("ProjectWire")

  @@index([maker, model])
}

// Grounding system details
model GroundingSystem {
  id               Int                @id @default(autoincrement())
  metalPartsGrounded Boolean  @default(true)
  cableSection       Float?
  resistance         Float?
  isCompliant        Boolean  @default(true)
  complianceIssue    String?
  
  // Relationships
  projectEquipment ProjectEquipment[] @relation("ProjectGrounding")
  
  @@map("grounding_systems")
}

model ProjectEquipment {
  type               EquipmentType
  quantity           Int               @default(1)
  position           Json?
  specifications     Json?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  id                 Int               @id @default(autoincrement())
  projectId          Int
  equipmentId        Int
  pvPanelId          Int?
  inverterId         Int?
  mountingHardwareId Int?
  wireId             Int?
  groundId           Int?
  protectionDeviceId Int?
  batteryBankId      Int?
  chargeControllerId Int?
  batteryBank        BatteryBank?      @relation("ProjectBatteryBank", fields: [batteryBankId], references: [id])
  chargeController   ChargeController? @relation("ProjectChargeController", fields: [chargeControllerId], references: [id])
  inverter           Inverter?         @relation("ProjectInverter", fields: [inverterId], references: [id])
  mountingHardware   MountingHardware? @relation("ProjectMountingHardware", fields: [mountingHardwareId], references: [id])
  project            PVProject         @relation(fields: [projectId], references: [id])
  protectionDevice   ProtectionDevice? @relation("ProjectProtectionDevice", fields: [protectionDeviceId], references: [id])
  pvPanel            PVPanel?          @relation("ProjectPVPanel", fields: [pvPanelId], references: [id])
  wire               Wire?             @relation("ProjectWire", fields: [wireId], references: [id])
  grounding          GroundingSystem?  @relation("ProjectGrounding", fields: [groundId], references: [id])

  @@unique([projectId, equipmentId, type])
  @@index([projectId])
  @@index([equipmentId])
}

model PVProject {
  id               Int                @id @default(autoincrement())
  name             String
  customer         String
  address          String
  country          String
  description      String?
  city             String?
  designer         String?
  latitude         Float
  longitude        Float
  elevation        Float
  timezone         Int
  powerkW          Float
  numberPanels     Int
  numberOfStrings  Int
  reference        String
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  loads            Load[]
  arrays           PVArray[]
  gridVoltage      Int
  gridFrequency    Int
  projectEquipment ProjectEquipment[]

  // AI Relations
  aiDesigns        AiDesign[]          @relation("AiDesigns")
}

model PVArray {
  id                     Int       @id @default(autoincrement())
  tilt                   Float
  azimuth                Float
  mountingConfiguration  String?
  spaceUnderPanel        Float
  mountingHeight         Float
  groundSurfaceCondition String?
  albedo                 Float
  unitsInSeries          Int
  stringsInParallel      Int
  arrayVmp               Float
  arrayImp               Float
  totalPanels            Int
  projectId              Int
  project                PVProject @relation(fields: [projectId], references: [id])
}


// Enums for categorizing devices
enum DeviceType {
  FUSE
  DISCONNECT_SWITCH
  CIRCUIT_BREAKER
  SURGE_PROTECTOR
}

enum SystemSide {
  DC
  AC
}

enum UserRole {
  ADMIN
  USER
}

enum SurveyStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
  ON_HOLD
}

enum ProjectStatus {
  NOT_STARTED
  PLANNING
  IN_PROGRESS
  COMPLETED
  ON_HOLD
}

enum TaskStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  ON_HOLD
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum EquipmentType {
  PV_PANEL
  INVERTER
  MOUNTING_HARDWARE
  MISC_EQUIPMENT
  WIRE
  GROUNDING
  PROTECTION
}

// ============================================================================
// AI SOLAR PV DESIGN ADDITIONS
// ============================================================================

// New Enums for AI functionality
enum AIPerformanceClass {
  PREMIUM
  STANDARD
  BUDGET
}

enum AIDesignStatus {
  PROCESSING
  COMPLETED
  FAILED
  EXPIRED
}

// AI Intelligence for Panels - SEPARATE from master panel data
model AiPanelIntelligence {
  id                    String   @id @default(uuid()) @map("id")
  panelId               Int      @unique @map("panel_id")
  performanceClass      AIPerformanceClass @map("performance_class")
  efficiencyRating      Int      @map("efficiency_rating") // 0-100
  reliabilityScore      Int      @map("reliability_score") // 0-100
  valueRating           Int      @map("value_rating") // 0-100
  compatibilityScore    Int      @map("compatibility_score") // 0-100

  // AI-computed technical insights
  temperaturePerformance Json?    @map("temperature_performance")
  spaceEfficiency       Json?    @map("space_efficiency")
  installationComplexity String?  @map("installation_complexity")

  // Market and cost intelligence
  marketIntelligence     Json?    @map("market_intelligence")
  costAnalysis          Json?    @map("cost_analysis")

  // Performance analytics
  performanceAnalytics   Json?    @map("performance_analytics")
  complianceData        Json?    @map("compliance_data")

  // AI metadata
  lastUpdated           DateTime @default(now()) @map("last_updated")
  dataQualityScore      Int      @map("data_quality_score") // 0-100
  aiModelVersion        String?  @map("ai_model_version")
  sourceReliability     Int      @map("source_reliability") // 0-100

  @@index([panelId], map: "idx_ai_panel_panel_id")
  @@index([performanceClass], map: "idx_ai_panel_performance_class")
  @@index([efficiencyRating], map: "idx_ai_panel_efficiency")
  @@index([reliabilityScore], map: "idx_ai_panel_reliability")
  @@map("ai_panel_intelligence")
}

// AI Intelligence for Inverters - SEPARATE from master inverter data
model AiInverterIntelligence {
  id                    String   @id @default(uuid()) @map("id")
  inverterId            Int      @unique @map("inverter_id")
  performanceClass      AIPerformanceClass @map("performance_class")
  efficiencyRating      Int      @map("efficiency_rating") // 0-100
  reliabilityScore      Int      @map("reliability_score") // 0-100
  valueRating           Int      @map("value_rating") // 0-100
  compatibilityScore    Int      @map("compatibility_score") // 0-100

  // AI-computed technical insights
  inverterTopology      String?  @map("inverter_topology")
  advancedFeatures      Json?    @map("advanced_features")
  integrationCapabilities Json?  @map("integration_capabilities")

  // Market and cost intelligence
  marketIntelligence     Json?    @map("market_intelligence")
  costAnalysis          Json?    @map("cost_analysis")

  // Performance analytics
  performanceAnalytics   Json?    @map("performance_analytics")
  complianceData        Json?    @map("compliance_data")

  // AI metadata
  lastUpdated           DateTime @default(now()) @map("last_updated")
  dataQualityScore      Int      @map("data_quality_score") // 0-100
  aiModelVersion        String?  @map("ai_model_version")
  sourceReliability     Int      @map("source_reliability") // 0-100

  @@index([inverterId], map: "idx_ai_inverter_inverter_id")
  @@index([performanceClass], map: "idx_ai_inverter_performance_class")
  @@index([efficiencyRating], map: "idx_ai_inverter_efficiency")
  @@index([reliabilityScore], map: "idx_ai_inverter_reliability")
  @@map("ai_inverter_intelligence")
}

// AI Compatibility Matrix - Links equipment together
model AiCompatibilityMatrix {
  id                    String   @id @default(uuid()) @map("id")
  panelId               Int      @map("panel_id")
  inverterId            Int      @map("inverter_id")

  // Compatibility scoring
  overallScore          Decimal  @map("overall_score") @db.Decimal(5, 2) // 0-100
  voltageCompatibility   Decimal? @map("voltage_compatibility") @db.Decimal(5, 2)
  currentCompatibility  Decimal? @map("current_compatibility") @db.Decimal(5, 2)
  powerCompatibility    Decimal? @map("power_compatibility") @db.Decimal(5, 2)
  temperatureCompatibility Decimal? @map("temperature_compatibility") @db.Decimal(5, 2)

  // Detailed analysis
  compatibilityFactors   Json?    @map("compatibility_factors")
  limitations           Json?    @map("limitations")
  recommendations       Json?    @map("recommendations")

  // Configuration suggestions
  stringConfiguration   Json?    @map("string_configuration")
  optimalArraySize      Json?    @map("optimal_array_size")

  // Metadata
  lastValidated         DateTime @default(now()) @map("last_validated")
  aiModelVersion        String?  @map("ai_model_version")

  // Ensure unique combinations
  @@unique([panelId, inverterId], map: "unique_panel_inverter_compatibility")
  @@index([panelId], map: "idx_compatibility_panel_id")
  @@index([inverterId], map: "idx_compatibility_inverter_id")
  @@index([overallScore], map: "idx_compatibility_overall_score")
  @@map("ai_compatibility_matrix")
}

// AI Design Results - Store AI-generated designs
model AiDesign {
  id                    String   @id @default(uuid()) @map("id")
  userId                Int      @map("user_id")
  projectId             Int?     @map("project_id")

  // Input requirements
  requirements          Json     @map("requirements")
  locationContext       Json     @map("location_context")

  // AI design results
  designResult          Json     @map("design_result")
  equipmentSelections   Json     @map("equipment_selections")
  systemConfiguration   Json     @map("system_configuration")

  // Analysis results
  performanceEstimates  Json     @map("performance_estimates")
  costAnalysis          Json     @map("cost_analysis")
  complianceResults     Json     @map("compliance_results")

  // Alternative designs
  alternatives          Json?    @map("alternatives")

  // AI metadata
  status                AIDesignStatus @default(PROCESSING) @map("status")
  confidenceScore       Decimal? @map("confidence_score") @db.Decimal(5, 2)
  processingTimeMs      Int?     @map("processing_time_ms")
  aiModelVersion        String?  @map("ai_model_version")

  // Timestamps
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  completedAt           DateTime? @map("completed_at")

  // Relations
  user                  User     @relation("AiDesigns", fields: [userId], references: [id])
  project               PVProject? @relation("AiDesigns", fields: [projectId], references: [id])
  analytics             AiDesignAnalytics[] @relation("AiDesignAnalytics")

  @@index([userId], map: "idx_ai_designs_user_id")
  @@index([projectId], map: "idx_ai_designs_project_id")
  @@index([status], map: "idx_ai_designs_status")
  @@index([createdAt], map: "idx_ai_designs_created_at")
  @@map("ai_designs")
}

// User AI Preferences - Learn from user behavior
model UserAiPreferences {
  id                    String   @id @default(uuid()) @map("id")
  userId                Int      @unique @map("user_id")

  // User preferences
  equipmentPreferences  Json?    @map("equipment_preferences")
  budgetPreferences     Json?    @map("budget_preferences")
  brandPreferences      Json?    @map("brand_preferences")
  aestheticPreferences  Json?    @map("aesthetic_preferences")
  performancePriorities Json?    @map("performance_priorities")

  // Learning data
  interactionHistory    Json?    @map("interaction_history")
  feedbackData          Json?    @map("feedback_data")
  learnedPreferences    Json?    @map("learned_preferences")

  // Timestamps
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relations
  user                  User     @relation("UserAiPreferences", fields: [userId], references: [id])

  @@index([userId], map: "idx_user_ai_preferences_user_id")
  @@map("user_ai_preferences")
}

// AI Design Analytics - Track AI performance and user feedback
model AiDesignAnalytics {
  id                    String   @id @default(uuid()) @map("id")
  designId              String   @map("design_id")
  userId                Int      @map("user_id")

  // Design interaction data
  originalRequirements  Json     @map("original_requirements")
  aiRecommendations     Json     @map("ai_recommendations")
  userModifications     Json?    @map("user_modifications")
  finalDesign           Json?    @map("final_design")

  // User feedback
  userSatisfactionScore Int?     @map("user_satisfaction_score") // 1-5
  feedbackText          String?  @map("feedback_text")
  feedbackCategories    Json?    @map("feedback_categories")

  // Performance tracking
  performanceAccuracy   Json?    @map("performance_accuracy")
  costVsEstimate        Json?    @map("cost_vs_estimate")
  timeToComplete        Int?     @map("time_to_complete") // milliseconds

  // Learning data
  userSkillLevel        String?  @map("user_skill_level")
  designComplexity      String?  @map("design_complexity")
  successFactors        Json?    @map("success_factors")
  improvementAreas      Json?    @map("improvement_areas")

  // Timestamps
  createdAt             DateTime @default(now()) @map("created_at")

  // Relations
  design                AiDesign @relation("AiDesignAnalytics", fields: [designId], references: [id])
  user                  User     @relation("AiDesignAnalytics", fields: [userId], references: [id])

  @@index([designId], map: "idx_ai_analytics_design_id")
  @@index([userId], map: "idx_ai_analytics_user_id")
  @@index([createdAt], map: "idx_ai_analytics_created_at")
  @@map("ai_design_analytics")
}

// Market Intelligence Data - External market data separate from equipment specs
model MarketIntelligence {
  id                    String   @id @default(uuid()) @map("id")
  equipmentType         String   @map("equipment_type") // 'panel', 'inverter', 'battery'
  equipmentId           Int      @map("equipment_id")
  regionCode            String   @map("region_code") // 'US-CA', 'EU-DE', etc.

  // Market data
  currentPrice          Decimal  @map("current_price") @db.Decimal(10, 2)
  priceHistory          Json     @map("price_history")
  availabilityStatus    String   @map("availability_status")
  leadTimeDays          Int?     @map("lead_time_days")

  // Supplier data
  primarySuppliers      Json     @map("primary_suppliers")
  supplierRatings       Json     @map("supplier_ratings")
  regionalAvailability  Json     @map("regional_availability")

  // Market intelligence
  marketShare           Decimal? @map("market_share") @db.Decimal(5, 2)
  popularityScore       Int?     @map("popularity_score") // 0-100
  competitivePosition   Json?    @map("competitive_position")

  // Validity
  validFrom             DateTime @default(now()) @map("valid_from")
  validUntil            DateTime? @map("valid_until")

  // Metadata
  source                String   @map("source") // Data source
  lastUpdated           DateTime @default(now()) @map("last_updated")
  confidenceLevel       Int      @map("confidence_level") // 0-100

  @@unique([equipmentType, equipmentId, regionCode], map: "unique_market_intelligence")
  @@index([equipmentType, equipmentId], map: "idx_market_equipment")
  @@index([regionCode], map: "idx_market_region")
  @@index([availabilityStatus], map: "idx_market_availability")
  @@map("market_intelligence")
}
